---
createTime: 2024-11-08
excerpt: qiankun å¯èƒ½æ˜¯ä½ è§è¿‡æœ€å®Œå–„çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ ğŸ§
title: å¾®å‰ç«¯ä¹‹ Vite + qiankun + Vue3
tags:
  - ElementPlus
  - å¾®å‰ç«¯
  - qiankun
  - Vue.js
cover: https://upyun-oss.mu00.cn/202411082028337.png
---

<!-- # å¾®å‰ç«¯ä¹‹ Vite + qiankun + Vue3 -->

> [qiankun](https://qiankun.umijs.org/zh)å¯èƒ½æ˜¯ä½ è§è¿‡æœ€å®Œå–„çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ ğŸ§

- ç®€å•: ä»»æ„ js æ¡†æ¶å‡å¯ä½¿ç”¨ã€‚å¾®åº”ç”¨æ¥å…¥åƒä½¿ç”¨æ¥å…¥ä¸€ä¸ª iframe ç³»ç»Ÿä¸€æ ·ç®€å•ï¼Œä½†å®é™…ä¸æ˜¯ iframeã€‚
- å®Œå¤‡: å‡ ä¹åŒ…å«æ‰€æœ‰æ„å»ºå¾®å‰ç«¯ç³»ç»Ÿæ—¶æ‰€éœ€è¦çš„åŸºæœ¬èƒ½åŠ›ï¼Œå¦‚ æ ·å¼éš”ç¦»ã€js æ²™ç®±ã€é¢„åŠ è½½ç­‰ã€‚
- ç”Ÿäº§å¯ç”¨: å·²åœ¨èš‚èšå†…å¤–ç»å—è¿‡è¶³å¤Ÿå¤§é‡çš„çº¿ä¸Šç³»ç»Ÿçš„è€ƒéªŒåŠæ‰“ç£¨ï¼Œå¥å£®æ€§å€¼å¾—ä¿¡èµ–ã€‚

## 1ã€ä¸»åº”ç”¨æ”¹é€ 

æŠ€æœ¯æ ˆï¼š`Vite` + `Vue3`

### 1.1ã€å®‰è£… qiankun

```bash
npm i qiankun
```

### 1.2ã€å­åº”ç”¨ç®¡ç†é…ç½®

é¡¹ç›®`src`ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`qiankun`è¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œæ–°å»º`config.js`

```js
// /src/qiankun/config,js

const subApps = [
  {
    name: "OneSon", // å­åº”ç”¨åç§°
    entry: "//localhost:3001", // å­åº”ç”¨å…¥å£
    container: "#subapp-viewport", // å­åº”ç”¨æŒ‚è½½çš„dom
    activeRule: "/one-son", // å­åº”ç”¨è§¦å‘çš„è·¯ç”±è§„åˆ™
    props: {}, // å­åº”ç”¨ä¼ é€’çš„å‚æ•°
  },
  {
    name: "TwoSon",
    entry: "//localhost:3002",
    container: "#subapp-viewport",
    activeRule: "/two-son",
    props: {}, // å­åº”ç”¨ä¼ é€’çš„å‚æ•°
  },
];

/**
 * åˆ›å»ºå­åº”ç”¨
 * @param {Object} props çˆ¶åº”ç”¨ä¼ é€’ç»™å­åº”ç”¨çš„å‚æ•°
 * @returns
 */
export const createSubApps = (props) => {
  return subApps.map((item) => {
    return {
      ...item,
      props: {
        ...item.props,
        ...props,
      },
    };
  });
};
```

### 1.3ã€å­åº”ç”¨æ³¨å†Œ

```js
// src/qiankun/qiankunHooks.js

const useQianKunHooks = () => {
  const registerApps = (props) => {
    try {
      registerMicroApps(createSubApps(props), {
        beforeLoad: [
          async (app) => {
            console.log("before load", app.name);
          },
        ],
        beforeMount: [
          async (app) => {
            console.log("before mount", app.name);
          },
        ],
        afterMount: [
          async (app) => {
            console.log("after mount", app.name);
          },
        ],
      });
    } catch (e) {
      console.error(e);
    }
  };
  const initQianKun = (props) => {
    if (window.qiankunStarted) return;
    registerApps(props);
    start({
      prefetch: "all",
      sandbox: {
        experimentalStyleIsolation: true, // æ ·å¼éš”ç¦»ï¼ˆéä¸¥æ ¼æ¨¡å¼ï¼‰
      },
      // è¿‡æ»¤å­åº”ç”¨èµ„æºåŠ è½½
      excludeAssetFilter: (assetUrl) => {
        const witeList = ["map.qq.com"];
        return !witeList.some((url) => assetUrl.includes(url));
      },
    });
  };

  return {
    initQianKun,
  };
};

export default useQianKunHooks;
```

### 1.4ã€Layout æ”¹é€ 

åœ¨`src/components`ç›®å½•ä¸‹æ–°å»ºç»„ä»¶`SubAppComponent.vue`ï¼Œä½œä¸ºå­åº”ç”¨`compontent`ç»„ä»¶ï¼Œé‡Œé¢åªéœ€è¦`<template></template>`æ ‡ç­¾

```html
<!-- /src/components/SubAppComponent.vue -->

<template></template>
```

ä¿®æ”¹`src/layout/main.vue`æ–‡ä»¶

- `template`ç»“æ„

åœ¨`router-view`ä¸‹æ–°å¢`<div id="subapp-viewport"></div>`ä½œä¸ºå­åº”ç”¨çš„æŒ‚è½½å®¹å™¨ï¼›

```html
<el-container class="h-screen">
  <el-aside width="200px" class="bg-[#001529]">
    <el-scrollbar>
      <el-menu
        active-text-color="#fff"
        background-color="#001529"
        text-color="#B2B6B9"
        :default-active="route.path"
        router
      >
        <el-menu-item index="/">
          <el-icon><Setting /></el-icon>
          <span>Dashboard</span>
        </el-menu-item>
      </el-menu>
    </el-scrollbar>
  </el-aside>
  <el-main class="bg-gray-100">
    <router-view />
    <div id="subapp-viewport"></div>
  </el-main>
</el-container>
```

- `script setup`é€»è¾‘

```js
import useQianKunHooks from "@/qiankun/qiankunHooks";
import { onBeforeMount } from "vue";
const { initQianKun } = useQianKunHooks();

onBeforeMount(() => {
  // åˆå§‹åŒ–ä¹¾å¤ï¼Œä¼ å…¥æ•°æ®ï¼›å¦‚token
  const props = {
    token: "adminToken",
  };
  initQianKun(props);
});
```

### 1.5ã€æ·»åŠ å­åº”ç”¨è·¯ç”±

```js
// src/router/index.js

import {
  createRouter,
  createWebHistory,
  createWebHashHistory,
} from "vue-router";
import Layout from "@/layout/main.vue";

const routes = [
  {
    path: "/",
    component: Layout,
    redirect: "",
    children: [
      {
        path: "",
        name: "dashboard",
        component: () => import("@/views/dashboard/index.vue"),
      },
      // å­åº”ç”¨one-son
      {
        path: "/one-son",
        name: "one-son",
        children: [
          {
            path: "/one-son/user",
            name: "one-son-user",
            component: () => import("@/components/SubAppComponent.vue"),
          },
        ],
      },
      // å­åº”ç”¨two-son
      {
        path: "/two-son",
        name: "two-son",
        children: [
          {
            path: "/two-son/dept",
            name: "two-son-dept",
            component: () => import("@/components/SubAppComponent.vue"),
          },
        ],
      },
    ],
  },
];

const router = createRouter({
  routes,
  history: createWebHistory(),
});

/**
 * å…¨å±€å‰ç½®å®ˆå«
 */
router.beforeEach((to, from) => {});

export default router;
```

åœ¨`layout`ä¸­æ·»åŠ å¯¹åº”èœå•

```html
<el-menu
  active-text-color="#fff"
  background-color="#001529"
  text-color="#B2B6B9"
  :default-active="route.path"
  router
>
  <el-menu-item index="/">
    <el-icon><Setting /></el-icon>
    <span>Dashboard</span>
  </el-menu-item>
  <el-menu-item index="/one-son/user">
    <el-icon><Setting /></el-icon>
    <span>ç”¨æˆ·ç®¡ç†</span>
  </el-menu-item>
  <el-menu-item index="/two-son/dept">
    <el-icon><Setting /></el-icon>
    <span>éƒ¨é—¨ç®¡ç†</span>
  </el-menu-item>
</el-menu>
```

**æ³¨æ„**

- è‹¥å­åº”ç”¨åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ä»£ç†ï¼Œåˆ™éœ€è¦æŠŠå­åº”ç”¨çš„ä»£ç†ä¹ŸåŠ å…¥åˆ°ä¸»åº”ç”¨é‡Œé¢

## 2ã€å­åº”ç”¨æ”¹é€ 

### 2.1ã€ä¿®æ”¹ vite.config é…ç½®

- å®‰è£…`vite-plugin-qiankun`æ’ä»¶
- å¼•ç”¨`qiankun`æ’ä»¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå­åº”ç”¨åç§°ï¼Œéœ€è¦å’Œä¸»åº”ç”¨ä¸­æ³¨å†Œçš„å­åº”ç”¨åç§°ä¸€è‡´

```js
// vite.config.js

import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import WindiCSS from "vite-plugin-windicss";
import qiankun from "vite-plugin-qiankun";

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    vue(),
    WindiCSS(),
    qiankun("OneSon", {
      useDevMode: true,
    }),
  ],
  resolve: {
    alias: {
      "@": "/src",
    },
  },
});
```

### 2.2ã€æ”¹é€ å…¥å£ main

- æ·»åŠ `registerMicroApps`ç›¸å…³é…ç½®

```js
// src/main.js

import { createApp } from "vue";
import "virtual:windi.css";
import App from "./App.vue";
import router from "./router";
import ElementPlus from "element-plus";
import "element-plus/dist/index.css";
import {
  renderWithQiankun,
  qiankunWindow,
} from "vite-plugin-qiankun/dist/helper";

let app;

const bootstrap = (container) => {
  app = createApp(App);
  app.use(ElementPlus);
  app.use(router);
  app.mount(container ? container.querySelector("#app") : "#app");
};

const initQiankun = () => {
  renderWithQiankun({
    mount(props) {
      const { container, token } = props;
      console.log("ä¸»åº”ç”¨ä¼ é€’çš„tokenï¼š" + token);
      bootstrap(container);
    },
    bootstrap() {},
    unmount(props) {
      app.unmount();
    },
  });
};

qiankunWindow.__POWERED_BY_QIANKUN__ ? initQiankun() : bootstrap();
```

### 2.3ã€æ”¹é€ è·¯ç”±(History)

```js
// src/router/index.js

import {
  createRouter,
  createWebHistory,
  createWebHashHistory,
} from "vue-router";
import Layout from "@/layout/main.vue";
import { qiankunWindow } from "vite-plugin-qiankun/dist/helper";

const routes = [
  {
    path: "/",
    component: Layout,
    redirect: "/user",
    children: [
      {
        path: "user",
        name: "user",
        component: () => import("@/views/user/index.vue"),
      },
    ],
  },
];

const router = createRouter({
  routes,
  // åˆ¤æ–­æ˜¯å¦æ˜¯qiankunç¯å¢ƒ
  history: createWebHistory(
    qiankunWindow.__POWERED_BY_QIANKUN__ ? "/one-son" : ""
  ),
});

/**
 * å…¨å±€å‰ç½®å®ˆå«
 */
router.beforeEach((to, from) => {});

export default router;
```

---

**æ‰©å±•**

> è·¯ç”±ä½¿ç”¨`Hash`æ¨¡å¼

1. å°†ä¸»åº”ç”¨è·¯ç”±æ¨¡å¼æ”¹ä¸º`createWebHashHistory`
2. å­åº”ç”¨ä¿®æ”¹è·¯ç”±æ¨¡å¼ä¸º

```js
// src/router/index.js

const router = createRouter({
  routes,
  history: createWebHashHistory(
    qiankunWindow.__POWERED_BY_QIANKUN__ ? "/#/two-son" : ""
  ),
});
```

å¼ºçƒˆä¸æ¨èï¼Œæ§åˆ¶å°æœ‰è­¦å‘Š âš 

## 3ã€æ¼”ç¤º

![æ¼”ç¤º](https://upyun-oss.mu00.cn/202411082027881.gif)

> [!tip]
>
> GItee ä»“åº“åœ°å€ï¼š[https://gitee.com/SunnyBoy_mu/qiankun-template](https://gitee.com/SunnyBoy_mu/qiankun-template)

## 4ã€FAQ

1. `WindiCSS`ä¸»å­åº”ç”¨ç›¸äº’å½±å“æ ·å¼ï¼Œæš‚æœªè§£å†³
